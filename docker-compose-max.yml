version: "3.9"

services:
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: password
    ports:
      - "5672:5672"     # AMQP
      - "15672:15672"   # Management UI (http://localhost:15672)
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 15
    networks: [ backend ]

  orderservice:
    build:
      context: ./orderservice
      dockerfile: Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      # Spring: Rabbit-Verbindung im Container (NICHT localhost)
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: user
      SPRING_RABBITMQ_PASSWORD: password

      # HTTP-Port
      SERVER_PORT: 8080

      # Invoice-Speicher in gemountetem Ordner
      APP_INVOICE_STORAGE_DIR: /data/invoices
      APP_INVOICE_BASE_URL: http://orderservice:8080/files/invoices

      # (Optional) falls du die Queue-Namen per Env Ã¼berschreiben willst:
      APP_RABBIT_PAYMENT_EXCHANGE: payments.exchange
      APP_RABBIT_PAYMENT_ROUTING_KEY: payment.requested
      APP_RABBIT_REQUEST_QUEUE: payment.requested.queue
      APP_RABBIT_PROCESSED_QUEUE: payment.processed.queue
      APP_RABBIT_PROCESSED_ROUTING_KEY: payment.processed
    ports:
      - "8080:8080"
    volumes:
      - invoices:/data/invoices
    networks: [ backend ]

  paymentservice:
    build:
      context: ./payment
      dockerfile: Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: user
      SPRING_RABBITMQ_PASSWORD: password

      SERVER_PORT: 8081

      APP_RABBIT_EXCHANGE: payments.exchange
      APP_RABBIT_REQUEST_QUEUE: payment.requested.queue
      APP_RABBIT_REQUEST_ROUTING_KEY: payment.requested
      APP_RABBIT_PROCESSED_EXCHANGE: payments.exchange
      APP_RABBIT_PROCESSED_ROUTING_KEY: payment.processed

      # Simulator
      APP_PAYMENT_SIMULATOR_SUCCESS_RATE: "0.9"
      APP_PAYMENT_SIMULATOR_DELAY_MS: "500"
    ports:
      - "8081:8081"
    networks: [ backend ]

  mailhog:
    image: mailhog/mailhog
    container_name: mailhog
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI http://localhost:8025
    networks: [ backend ]

  notificationservice:
    build:
      context: ./notificationservice
      dockerfile: Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      # orderservice is not strictly required at startup, but useful for invoice fetch
      orderservice:
        condition: service_started
    environment:
      # RabbitMQ (use the container hostname, not localhost)
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: user
      SPRING_RABBITMQ_PASSWORD: password

      # SMTP (MailHog in dev)
      SPRING_MAIL_HOST: mailhog
      SPRING_MAIL_PORT: 1025
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: "false"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: "false"

      # Service port
      SERVER_PORT: 8082

      # Rabbit topology for notification (adjust to your config)
      # Exchange/route the Order service will publish to:
      APP_NOTIFICATION_EXCHANGE: email.exchange
      APP_NOTIFICATION_QUEUE: email.send.queue
      APP_NOTIFICATION_ROUTING_KEY: email.send

      ORDER_SERVICE_BASE_URL: http://orderservice:8080
    ports:
      - "8082:8082"
    networks: [ backend ]

networks:
  backend: { driver: bridge }

volumes:
  invoices:
